# Canon Specification — Schema v1.2

This document defines the data schema for a valid opencanon repository.

---

## metadata.json (required per episode)

Location: `stories/{episode-id}/metadata.json`

```json
{
  "schema_version": "1.2",
  "canon_ref": "owner/repo",
  "id": "ep01-genesis",
  "episode": 1,
  "title": {
    "ko": "제목",
    "en": "Title"
  },
  "timeline": "2029-03-15",
  "synopsis": {
    "ko": "한 줄 줄거리",
    "en": "One-line synopsis"
  },
  "characters": ["character-id"],
  "locations": ["location-id"],
  "contributor": "github-username",
  "canon_status": "canonical",
  "temporal_context": {
    "prev_episode": null,
    "next_episode": null,
    "thematic_echoes": []
  }
}
```

### Field rules

| Field | Type | Required | Constraint |
|---|---|---|---|
| `schema_version` | string | ✓ | Must be exactly `"1.2"` |
| `canon_ref` | string | ✓ | Format: `"{owner}/{repo}"` — must match GitHub repo |
| `id` | string | ✓ | `/^[a-z0-9][a-z0-9_-]*$/` |
| `episode` | integer | ✓ | Positive integer |
| `title` | object | ✓ | At least one locale key (`ko`, `en`, or `ja`) |
| `timeline` | string | ✓ | `YYYY-MM-DD` only — no time component |
| `synopsis` | object | ✓ | At least one locale key |
| `characters` | string[] | ✓ | Each entry must match a file in `canon/characters/` |
| `locations` | string[] | ✓ | Each entry must match a file in `canon/worldbuilding/locations/` |
| `contributor` | string | ✓ | Non-empty. Typically GitHub username |
| `canon_status` | string | ✓ | `"canonical"` or `"non-canonical"` |
| `temporal_context` | object | ✓ | All sub-fields present (null is valid for episode refs) |
| `temporal_context.prev_episode` | string\|null | ✓ | Must resolve to existing episode ID, or null |
| `temporal_context.next_episode` | string\|null | ✓ | Must resolve to existing episode ID, or null |
| `temporal_context.thematic_echoes` | string[] | ✓ | Each entry must resolve to existing episode ID |

---

## character definition.json

Location: `canon/characters/{id}/definition.json`

```json
{
  "id": "isia",
  "name": "Isia",
  "role": "protagonist",
  "description": "A brief description of the character."
}
```

Minimum required field: `id` (string, matches directory name).

---

## location definition JSON

Location: `canon/worldbuilding/locations/{id}.json`

```json
{
  "id": "seoul-tower",
  "name": "Seoul Tower",
  "description": "A brief description of the location."
}
```

Minimum required field: `id` (string, matches filename without extension).

---

## .canonrc.json

Location: repo root

```json
{
  "schema_version": "canonrc.v1",
  "author": "github-username",
  "default_lang": "ko"
}
```

| Field | Type | Default | Purpose |
|---|---|---|---|
| `schema_version` | string | `"canonrc.v1"` | Schema marker |
| `author` | string | `""` | Default `contributor` for new episodes |
| `default_lang` | string | `"ko"` | Default locale for titles/synopses |

---

## canon.lock.json

Auto-generated by `canon lock`. Do not edit manually.

```json
{
  "schema_version": "lock.v1",
  "canon_commit": "owner/repo",
  "lockedAt": "2026-02-25T17:00:00.000Z",
  "checksum": "sha256:..."
}
```

The `canon_version_match` check compares `canon_ref` in `metadata.json` against `canon_commit` in this file. They must match exactly.

---

## Directory structure (complete)

```
{repo}/
├── canon/
│   ├── characters/
│   │   └── {id}/
│   │       └── definition.json
│   └── worldbuilding/
│       └── locations/
│           └── {id}.json
├── stories/
│   └── {episode-id}/
│       ├── metadata.json          ← required for compliance
│       ├── content.md             ← recommended (episode text)
│       ├── ko/
│       │   └── chapter-01.md      ← optional locale chapter
│       └── en/
│           └── chapter-01.md
├── canon.lock.json
├── .canonrc.json
├── .canon-refs.json               ← auto-generated by canon write
├── CONVENTIONS.md
└── GETTING-STARTED.md
```

---

## Compliance check summary

| Check ID | Passes when |
|---|---|
| `metadata_schema_valid` | All required fields present, types correct, `schema_version === "1.2"` |
| `characters_valid` | Every entry in `characters[]` has `canon/characters/{entry}/definition.json` |
| `locations_valid` | Every entry in `locations[]` has `canon/worldbuilding/locations/{entry}.json` |
| `timeline_consistent` | `timeline` is a valid `YYYY-MM-DD` with round-trip stability |
| `continuity_valid` | All episode references in `temporal_context` resolve or are null |
| `canon_version_match` | `canon_ref === canon.lock.json.canon_commit` (waived for first 30 days) |
| `contributor_valid` | `contributor` is a non-empty string |

All 7 checks must pass for score = 1.0. Partial passes yield fractional scores. Score > 0 required for public visibility on opencanon.co.
